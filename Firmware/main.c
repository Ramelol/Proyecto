#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <irq.h>
#include <uart.h>
#include <console.h>
#include "spiLCD.h"
#include "spiSD.h"
#include <generated/csr.h>


static uint16_t exp[899] ={
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,   // 0x0010 (16) pixels
0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0020 (32) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x7080, 0x8080, 0x8080, 0x8080, 0xA100, 0xA100,   // 0x0030 (48) pixels
0x0020, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0040 (64) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x9100, 0xA100, 0x9100, 0xB180, 0xB180, 0xB180, 0xD180, 0xD180,   // 0x0050 (80) pixels
0xB180, 0xB180, 0x0020, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0060 (96) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x9100, 0xA100, 0xD180, 0xE200, 0xE200, 0xF280, 0xF280, 0xE200, 0xE200,   // 0x0070 (112) pixels
0xD180, 0xB180, 0x9100, 0x8080, 0x0020, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0080 (128) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0xB180, 0xB180, 0xF280, 0xF480, 0xF480, 0xF480, 0xF380, 0xF380, 0xE200, 0xF280,   // 0x0090 (144) pixels
0xE200, 0xB180, 0x8080, 0x7080, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x00A0 (160) pixels
0x0000, 0x0000, 0x9100, 0x9100, 0xB180, 0xB180, 0xE200, 0xF380, 0xF380, 0xF380, 0xF380, 0xF380, 0xF380, 0xF380, 0xF480, 0xF480,   // 0x00B0 (176) pixels
0xF280, 0xB180, 0x8080, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020,   // 0x00C0 (192) pixels
0x0020, 0x9100, 0x9100, 0xB180, 0xB180, 0xE200, 0xF380, 0xF380, 0xF380, 0xF380, 0xF380, 0xF380, 0xF380, 0xF480, 0xF480, 0xF280,   // 0x00D0 (208) pixels
0xB180, 0x8080, 0x0020, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x7080, 0x4000,   // 0x00E0 (224) pixels
0x8080, 0xA100, 0xA100, 0xD180, 0xF480, 0xF380, 0xF480, 0xF480, 0xF280, 0xF380, 0xF480, 0xF480, 0xF4C0, 0xF500, 0xF560, 0xF480,   // 0x00F0 (240) pixels
0xA100, 0x6000, 0x0020, 0x0020, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x7080, 0x7080, 0x8080, 0x9100,   // 0x0100 (256) pixels
0xA100, 0xB180, 0xF480, 0xF560, 0xF5A0, 0xF560, 0xF560, 0xF500, 0xF500, 0xF500, 0xF480, 0xF480, 0xF5A0, 0xFE40, 0xF5E0, 0xF480,   // 0x0110 (272) pixels
0x8080, 0x4000, 0x4000, 0x6000, 0x2000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x6000, 0xB180, 0xD180, 0xD180, 0xD180,   // 0x0120 (288) pixels
0xF280, 0xF4C0, 0xFEC3, 0xFF07, 0xFF07, 0xFF07, 0xFF07, 0xF5E0, 0xF5A0, 0xF480, 0xF380, 0xF4C0, 0xFEC3, 0xFF07, 0xF4C0, 0xE200,   // 0x0130 (304) pixels
0x7080, 0x7080, 0x6000, 0x3000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x8080, 0xD180, 0xF380, 0xF280, 0xE200, 0xF280,   // 0x0140 (320) pixels
0xF500, 0xFF07, 0xFF07, 0xFFB2, 0xFFB2, 0xFE80, 0xF5A0, 0xF500, 0xF480, 0xF380, 0xF4C0, 0xFE40, 0xFF07, 0xF560, 0xF280, 0xA100,   // 0x0150 (336) pixels
0xA100, 0x8080, 0x8080, 0x2000, 0x0000, 0x0000, 0x0020, 0x0020, 0x0020, 0xB180, 0xF380, 0xF280, 0xF280, 0xE200, 0xF380, 0xF4C0,   // 0x0160 (352) pixels
0xFE80, 0xFEC3, 0xFE40, 0xFE40, 0xF5E0, 0xF4C0, 0xF480, 0xF380, 0xF280, 0xF480, 0xF5E0, 0xFE80, 0xF500, 0xF280, 0xD180, 0xD180,   // 0x0170 (368) pixels
0x9100, 0x8080, 0x2000, 0x0020, 0x0020, 0x0020, 0x9100, 0x9100, 0xF380, 0xF280, 0xE200, 0xD180, 0xF380, 0xF380, 0xF480, 0xF5A0,   // 0x0180 (384) pixels
0xF500, 0xF560, 0xF560, 0xF480, 0xF480, 0xF480, 0xF280, 0xF280, 0xF380, 0xF4C0, 0xFE80, 0xF4C0, 0xF480, 0xF280, 0xF280, 0xB180,   // 0x0190 (400) pixels
0x7080, 0x3000, 0x0020, 0x0020, 0x7080, 0x9100, 0x9100, 0xF380, 0xF280, 0xA100, 0xE200, 0xF480, 0xF480, 0xF480, 0xF480, 0xF4C0,   // 0x01A0 (416) pixels
0xF380, 0xF380, 0xF380, 0xF380, 0xF480, 0xF480, 0xF480, 0xF480, 0xF4C0, 0xF5A0, 0xF560, 0xF480, 0xF480, 0xF480, 0xE200, 0x8080,   // 0x01B0 (432) pixels
0x2000, 0x0020, 0x0020, 0x9100, 0x9100, 0x9100, 0xE200, 0xD180, 0xA100, 0xE200, 0xF380, 0xF380, 0xE200, 0xF480, 0xF280, 0xF380,   // 0x01C0 (448) pixels
0xF380, 0xD180, 0xE200, 0xF380, 0xF560, 0xF500, 0xF500, 0xF560, 0xF560, 0xF4C0, 0xF4C0, 0xF480, 0xF480, 0xF280, 0x9100, 0x3000,   // 0x01D0 (464) pixels
0x0020, 0x2000, 0x0020, 0x7080, 0x7080, 0xA100, 0xA100, 0xA100, 0xD180, 0xF280, 0xF280, 0xE200, 0xE200, 0xF280, 0xD180, 0xD180,   // 0x01E0 (480) pixels
0xA100, 0xA100, 0xF280, 0xF4C0, 0xF560, 0xFE40, 0xFE40, 0xF560, 0xF480, 0xF480, 0xF480, 0xF480, 0xF280, 0xB180, 0x3000, 0x0020,   // 0x01F0 (496) pixels
0x0000, 0x0020, 0x7080, 0x7080, 0xA100, 0xD180, 0xD180, 0xE200, 0xF380, 0xF480, 0xF380, 0xE200, 0xE200, 0xD180, 0xD180, 0xA100,   // 0x0200 (512) pixels
0xB180, 0xF380, 0xF4C0, 0xF5E0, 0xFF4B, 0xFF8F, 0xF5A0, 0xF480, 0xF480, 0xF480, 0xF480, 0xF280, 0xA100, 0x6000, 0x0020, 0x0000,   // 0x0210 (528) pixels
0x2000, 0x8080, 0x8080, 0xD180, 0xE200, 0xE200, 0xF280, 0xF480, 0xF500, 0xF480, 0xF380, 0xF280, 0xD180, 0xD180, 0xD180, 0xF380,   // 0x0220 (544) pixels
0xF480, 0xF5A0, 0xFE40, 0xFF8F, 0xFF4B, 0xF5A0, 0xF4C0, 0xF4C0, 0xF480, 0xF480, 0xE200, 0xB180, 0x7080, 0x0020, 0x0000, 0x0020,   // 0x0230 (560) pixels
0x8080, 0x8080, 0xB180, 0xD180, 0xD180, 0xD180, 0xF380, 0xF4C0, 0xF4C0, 0xF480, 0xF480, 0xF480, 0xF480, 0xF380, 0xF4C0, 0xF560,   // 0x0240 (576) pixels
0xF5A0, 0xF5E0, 0xFEC3, 0xF5A0, 0xF500, 0xF500, 0xF500, 0xF280, 0xF280, 0xD180, 0xA100, 0x9100, 0x0020, 0x0000, 0x0020, 0x7080,   // 0x0250 (592) pixels
0x7080, 0x8080, 0xB180, 0xA100, 0xB180, 0xD180, 0xF480, 0xF4C0, 0xF480, 0xF480, 0xF480, 0xF480, 0xF480, 0xF480, 0xF480, 0xF4C0,   // 0x0260 (608) pixels
0xF500, 0xF480, 0xF380, 0xF280, 0xF380, 0xF280, 0xA100, 0xA100, 0x7080, 0xA100, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020,   // 0x0270 (624) pixels
0x7080, 0x9100, 0xD180, 0xB180, 0xE200, 0xF280, 0xF480, 0xF380, 0xF380, 0xF480, 0xF480, 0xF380, 0xF380, 0xF380, 0xF480, 0xF380,   // 0x0280 (640) pixels
0xE200, 0xA100, 0x9100, 0xB180, 0xB180, 0x8080, 0x8080, 0x7080, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x7080,   // 0x0290 (656) pixels
0x8080, 0xB180, 0xD180, 0xB180, 0xE200, 0xE200, 0xE200, 0xF280, 0xF380, 0xF380, 0xF480, 0xF480, 0xF280, 0xF280, 0xF280, 0xA100,   // 0x02A0 (672) pixels
0xA100, 0xB180, 0xB180, 0xD180, 0x7080, 0x7080, 0x9100, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x7080, 0x8080,   // 0x02B0 (688) pixels
0xB180, 0xD180, 0xB180, 0xE200, 0xE200, 0xE200, 0xF280, 0xF380, 0xF380, 0xF480, 0xF480, 0xF280, 0xF280, 0xF280, 0xA100, 0xA100,   // 0x02C0 (704) pixels
0xB180, 0xB180, 0xD180, 0x7080, 0x7080, 0x9100, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x8080, 0x7080, 0x8080,   // 0x02D0 (720) pixels
0xA100, 0xB180, 0xB180, 0xE200, 0xE200, 0xE200, 0xF280, 0xF280, 0xF380, 0xF480, 0xF380, 0xF280, 0xE200, 0xD180, 0xB180, 0xE200,   // 0x02E0 (736) pixels
0xE200, 0xA100, 0x8080, 0x8080, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x9100, 0x8080,   // 0x02F0 (752) pixels
0x9100, 0xA100, 0xB180, 0xF280, 0xF380, 0xF380, 0xF380, 0xF480, 0xF4C0, 0xF480, 0xE200, 0xF280, 0xD180, 0xE200, 0xE200, 0xB180,   // 0x0300 (768) pixels
0x9100, 0x4000, 0x4000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x0020,   // 0x0310 (784) pixels
0x8080, 0xA100, 0xD180, 0xF280, 0xF380, 0xF380, 0xF480, 0xF480, 0xF380, 0xE200, 0xD180, 0xE200, 0xD180, 0xA100, 0xA100, 0x0020,   // 0x0320 (800) pixels
0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0330 (816) pixels
0xA100, 0xB180, 0xD180, 0xD180, 0xD180, 0xE200, 0xF280, 0xF280, 0xD180, 0xE200, 0xB180, 0x7080, 0x0020, 0x0020, 0x0020, 0x0000,   // 0x0340 (832) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020,   // 0x0350 (848) pixels
0xB180, 0xA100, 0xA100, 0xA100, 0xB180, 0xB180, 0xD180, 0x0000, 0x0000, 0x0000, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0360 (864) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0020,   // 0x0370 (880) pixels
0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0380 (896) pixels
};

static uint16_t g_over[864] ={
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0010 (16) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0020 (32) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0800, 0xB945, 0xB946, 0xB945, 0xB945, 0xB945, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0030 (48) pixels
0x0000, 0x78E4, 0xB966, 0x2882, 0x0000, 0x0000, 0x0000, 0xB945, 0xB945, 0x0000, 0x0000, 0x0000, 0x0000, 0xB945, 0xB945, 0x1800,   // 0x0040 (64) pixels
0xB945, 0xB945, 0xB945, 0xB945, 0xB945, 0xB946, 0xB945, 0x0000, 0x0000, 0x6883, 0xA0C4, 0xB945, 0xB945, 0xB945, 0xB945, 0xB945,   // 0x0050 (80) pixels
0xA8A3, 0x0000, 0x0000, 0x0800, 0xA0C4, 0x90E4, 0x8104, 0x98E4, 0x78A3, 0x0000, 0x0000, 0xB945, 0xB945, 0xA0C4, 0x0000, 0x0000,   // 0x0060 (96) pixels
0x98C3, 0xB945, 0xB945, 0x1800, 0xB945, 0xB945, 0xB945, 0xB945, 0xB945, 0xB945, 0xB945, 0x0000, 0x0000, 0x90C4, 0xE904, 0x3821,   // 0x0070 (112) pixels
0x0000, 0x0000, 0x0000, 0x7083, 0xE0E5, 0x0000, 0x1020, 0x2020, 0xD905, 0xA0C4, 0x1000, 0xD0E5, 0xB0E4, 0x1000, 0x0000, 0xB0E4,   // 0x0080 (128) pixels
0xE8E4, 0xE0E5, 0x0000, 0x0000, 0xD905, 0xE0E4, 0xE104, 0x1800, 0xC104, 0xC8E4, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0090 (144) pixels
0x0000, 0xA205, 0xF2E5, 0x38A1, 0x0000, 0x0000, 0x0000, 0x0800, 0x1820, 0x0000, 0xA245, 0xE2E6, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x00A0 (160) pixels
0x91E4, 0xE2E5, 0x0000, 0xC244, 0xDAA5, 0x1800, 0xAA45, 0xE2E7, 0x2820, 0xB204, 0xF2C6, 0x1000, 0xD285, 0xF2C5, 0xEAE5, 0xEAC5,   // 0x00B0 (176) pixels
0xEAC5, 0xEAE5, 0x99E5, 0x0000, 0x0000, 0xA2A4, 0xF3C4, 0x38E1, 0x0000, 0x0000, 0x8AC4, 0xA324, 0xA324, 0x0000, 0xAAC4, 0xF3A4,   // 0x00C0 (192) pixels
0xA324, 0xA324, 0xA324, 0xA324, 0xC364, 0xF3C4, 0x0000, 0xC304, 0xE385, 0x0000, 0xB225, 0xEAE6, 0x1820, 0xAAC4, 0xF3A5, 0x1020,   // 0x00D0 (208) pixels
0xD344, 0xE364, 0xAA24, 0xAA24, 0xAA24, 0xAA24, 0x7164, 0x0000, 0x0000, 0xAB45, 0xF4A5, 0x3921, 0x0000, 0x0000, 0xD425, 0xF4A4,   // 0x00E0 (224) pixels
0xF4A3, 0x0000, 0xB364, 0xF4A3, 0xF4A5, 0xF4A5, 0xFCA5, 0xF4A5, 0xF4A4, 0xF4A3, 0x0000, 0xC3C4, 0xE444, 0x0000, 0xAA45, 0xE2E7,   // 0x00F0 (240) pixels
0x1820, 0xAB64, 0xF485, 0x1020, 0xDC05, 0xD425, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xABC7, 0xFD67, 0x3942,   // 0x0100 (256) pixels
0x0000, 0x0000, 0x4143, 0x8B26, 0xFD67, 0x0000, 0xB406, 0xF548, 0x4982, 0x4983, 0x4983, 0x4983, 0xA3A6, 0xFD67, 0x0000, 0xC466,   // 0x0110 (272) pixels
0xED07, 0x0000, 0x3081, 0x40E2, 0x0000, 0xB406, 0xFD68, 0x1020, 0xDCC7, 0xDCC7, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0120 (288) pixels
0x0000, 0x8B26, 0xC488, 0x9CA6, 0xA4C5, 0xA4E5, 0xA4E5, 0xB546, 0xFE46, 0x0000, 0xB4A6, 0xF627, 0x0820, 0x0000, 0x0000, 0x0000,   // 0x0130 (304) pixels
0x9C25, 0xFE46, 0x0000, 0xC506, 0xE5E7, 0x0000, 0x0000, 0x0000, 0x0000, 0xB4A6, 0xF647, 0x1040, 0xDD87, 0xE606, 0xA4E5, 0xA4E5,   // 0x0140 (320) pixels
0xA4E5, 0x9CE5, 0x6B45, 0x0000, 0x0000, 0x0000, 0x0000, 0xEF06, 0xFF64, 0xFF64, 0xFF64, 0xFF64, 0xFF64, 0x0000, 0xBD66, 0xF746,   // 0x0150 (336) pixels
0x0841, 0x0000, 0x0000, 0x0000, 0x9CC5, 0xFF64, 0x0000, 0xC605, 0xEEE6, 0x0000, 0x0000, 0x0000, 0x0000, 0xB586, 0xFF66, 0x1060,   // 0x0160 (352) pixels
0xDE86, 0xFF64, 0xFF64, 0xFF64, 0xFF64, 0xFF84, 0xAD05, 0x0000, 0x0000, 0x0000, 0x0000, 0x5283, 0x52A3, 0x52A3, 0x52A3, 0x52A3,   // 0x0170 (368) pixels
0x52A3, 0x0000, 0x39E3, 0x5284, 0x0000, 0x0000, 0x0000, 0x0000, 0x3182, 0x52A4, 0x0000, 0x4204, 0x4A64, 0x0000, 0x0000, 0x0000,   // 0x0180 (384) pixels
0x0000, 0x39E3, 0x5283, 0x0020, 0x4A43, 0x52A3, 0x52A3, 0x52A3, 0x52A3, 0x52A3, 0x39A3, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0190 (400) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x01A0 (416) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x01B0 (432) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x01C0 (448) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x01D0 (464) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xB945, 0xB945, 0xB945, 0xB945, 0xB945, 0x0000, 0x0000, 0x2842, 0x3882,   // 0x01E0 (480) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x2041, 0x4083, 0x0000, 0x3062, 0x4062, 0x4062, 0x4062, 0x4062, 0x4082, 0x2862, 0x0000, 0x4062,   // 0x01F0 (496) pixels
0x4062, 0x4082, 0x4062, 0x4062, 0x3082, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0800, 0xB146, 0xC125, 0xB945, 0xB945, 0xB945,   // 0x0200 (512) pixels
0x0000, 0x0000, 0x88E4, 0xB945, 0x0000, 0x0000, 0x0000, 0x0000, 0x70C3, 0xC145, 0x0000, 0x9904, 0xC145, 0xC125, 0xC125, 0xC125,   // 0x0210 (528) pixels
0xC145, 0x80E4, 0x0000, 0xC145, 0xB945, 0xC125, 0xC125, 0xB945, 0xA945, 0x0820, 0x0000, 0x0000, 0x0000, 0x70A3, 0xB8C4, 0x70C4,   // 0x0220 (544) pixels
0x70C4, 0x70C4, 0x70C4, 0x80E4, 0xB0C4, 0x0000, 0x98C4, 0xD105, 0x0000, 0x0000, 0x0000, 0x0000, 0x80A3, 0xD905, 0x0000, 0xA8E4,   // 0x0230 (560) pixels
0xC904, 0x70C4, 0x70C4, 0x70C4, 0x70C4, 0x4883, 0x0000, 0xD905, 0x88E4, 0x70C4, 0x70C4, 0x70C4, 0x70E4, 0xB0E4, 0x70A3, 0x0000,   // 0x0240 (576) pixels
0x0000, 0x9904, 0xE944, 0x3840, 0x0000, 0x0000, 0x0000, 0x7883, 0xE944, 0x0000, 0xA0E4, 0xE145, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0250 (592) pixels
0x90E3, 0xE944, 0x0000, 0xB904, 0xD945, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xE944, 0x68C3, 0x0000, 0x0000, 0x0000,   // 0x0260 (608) pixels
0x0000, 0xE944, 0x90E4, 0x0000, 0x0000, 0x9A05, 0xEAC5, 0x38A1, 0x0000, 0x0000, 0x0000, 0x7984, 0xF2C5, 0x0000, 0xAA04, 0xEAC5,   // 0x0270 (624) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x91C4, 0xF2C5, 0x0000, 0xC244, 0xEAC4, 0xEAC5, 0xF2E5, 0xEAC5, 0xEAC5, 0xAA25, 0x0000, 0xF2C5,   // 0x0280 (640) pixels
0x7984, 0x0000, 0x0000, 0x0000, 0x0000, 0xF2C5, 0x99E4, 0x0000, 0x0000, 0xA2C5, 0xF405, 0x38E1, 0x0000, 0x0000, 0x0000, 0x8204,   // 0x0290 (656) pixels
0xF3E4, 0x0000, 0xB2E4, 0xEBE5, 0x0000, 0x0000, 0x0000, 0x0000, 0x9A84, 0xF3E4, 0x0000, 0xC324, 0xEBC5, 0x91E4, 0x99E4, 0x91E4,   // 0x02A0 (672) pixels
0x91E3, 0x6963, 0x0000, 0xF3E4, 0xCBA5, 0xBB85, 0xBB84, 0xB384, 0xAB66, 0x9204, 0x5943, 0x0000, 0x0000, 0xA344, 0xF4A5, 0x3921,   // 0x02B0 (688) pixels
0x0000, 0x0000, 0x0000, 0x7A83, 0xF4A4, 0x0000, 0xA365, 0xEC86, 0x0000, 0x0000, 0x0000, 0x0000, 0x9305, 0xECA6, 0x0000, 0xC3C4,   // 0x02C0 (704) pixels
0xE464, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFCA4, 0xF485, 0xEC86, 0xEC86, 0xEC86, 0xDC48, 0x0000, 0x0000, 0x0000,   // 0x02D0 (720) pixels
0x0000, 0xABE7, 0xFD88, 0x3942, 0x0000, 0x0000, 0x0000, 0x8305, 0xFD67, 0x0000, 0x0000, 0x0000, 0xED69, 0xB428, 0x0000, 0xE528,   // 0x02E0 (736) pixels
0xC487, 0x0000, 0x0000, 0xCC67, 0xE527, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xF587, 0x82E6, 0x0000, 0x0000, 0x0000,   // 0x02F0 (752) pixels
0x0000, 0xF569, 0x9BC7, 0x0000, 0x0000, 0x72E6, 0xAC07, 0xFF66, 0xFF66, 0xFF66, 0xFF66, 0xFF66, 0xB407, 0x0000, 0x0000, 0x0820,   // 0x0300 (768) pixels
0xAC08, 0xAC07, 0xFF66, 0xAC28, 0x8B67, 0x0000, 0x0000, 0xAC07, 0xFF66, 0xFF66, 0xFF66, 0xFF66, 0xFF66, 0xFF66, 0x0000, 0xFF66,   // 0x0310 (784) pixels
0xAC07, 0x0000, 0x0000, 0x0000, 0x0000, 0xFF66, 0xAC07, 0x0000, 0x0000, 0x0000, 0x0000, 0xFF66, 0xFF66, 0xFF66, 0xFF66, 0xFF66,   // 0x0320 (800) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFF66, 0xFF66, 0x4A65, 0x0000, 0x0000, 0x0000, 0xFF66, 0xFF66, 0x4204, 0x4204, 0x4204,   // 0x0330 (816) pixels
0xFF66, 0xFF66, 0x0000, 0xFF66, 0xFF66, 0x0000, 0x0000, 0x0000, 0x0000, 0xFF66, 0xFF66, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0340 (832) pixels
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0820, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,   // 0x0350 (848) pixels
0x0000, 0x0820, 0x0820, 0x0820, 0x0820, 0x0820, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0021, 0x0000, 0x0000, 0x0000,   // 0x0360 (864) pixels
};

static int start = 0;
int posNaveE = 168;
int posDisparo = 45;
int posNave1 = 0;
int vidas = 3;
int disparo = 0;
int juegoIniciado = 0;
static int gameOver = 0;
int disparoX = 0;


void disparar(void){
	if(disparo == 0){
		posNave1 = getPosNave1();
		disparoX = posNave1 + 16;
		disparo++;
	}
}
static void busy_wait(unsigned int ds)
{
	timer0_en_write(0);
	timer0_reload_write(0);
	timer0_load_write(SYSTEM_CLOCK_FREQUENCY/100*ds);
	timer0_en_write(1);
	timer0_update_value_write(1);
	while(timer0_value_read()) timer0_update_value_write(1);
}


static char *readstr(void)
{
	char c[2];
	static char s[64];
	static int ptr = 0;

	if(readchar_nonblock()) {
		c[0] = readchar();
		c[1] = 0;
		switch(c[0]) {
			case 0x7f:
			case 0x08:
				if(ptr > 0) {
					ptr--;
					putsnonl("\x08 \x08");
				}
				break;
			case 0x07:
				break;
			case '\r':
			case '\n':
				s[ptr] = 0x00;
				putsnonl("\n");
				ptr = 0;
				return s;
			default:
				if(ptr >= (sizeof(s) - 1))
					break;
				putsnonl(c);
				s[ptr] = c[0];
				ptr++;
				break;
		}
	}

	return NULL;
}

static char *get_token(char **str)
{
	char *c, *d;

	c = (char *)strchr(*str, ' ');
	if(c == NULL) {
		d = *str;
		*str = *str+strlen(*str);
		return d;
	}
	*c = 0;
	d = *str;
	*str = c+1;
	return d;
}

static void prompt(void)
{
	printf("RUNTIME>");
}

static void help(void)
{
	puts("Available commands:");
	puts("help                            - this command");
	puts("reboot                          - reboot CPU");
	puts("sdtest   - SDCard test");
	puts("game  -  gameTest");
									  		

}

static void reboot(void)
{
	asm("call r0");
}
void iniciarJuego(void)
{
	juegoIniciado++;
}


static void ponerTitulo(void){
	int pY = 130;
	int pX = 10;
	int tam = 5;

	leerBloque();
	uint8_t* data;
	data = leerNombre();

	int p = 1;
	for(int i=0;i<9;i++){	
		p = 16;
		for(int j=0;j<5;j++){
			if( (data[i] & p) == p){
			     dibujarTileColor(BLANCO,pX+tam*j,pY-tam*i,tam);
			}
			if( (data[i+9] & p) == p){
			     dibujarTileColor(BLANCO,(pX + 35)+tam*j,pY-tam*(i),tam);
			}
			if( (data[i+18] & p) == p){
			     dibujarTileColor(BLANCO,(pX + 70)+tam*j,pY-tam*(i),tam);
			}
			if( (data[i+27] & p) == p){
			     dibujarTileColor(BLANCO,(pX + 105)+tam*j,pY-tam*(i),tam);
			}
			if( (data[i+36] & p) == p){
			     dibujarTileColor(BLANCO,(pX + 140)+tam*j,pY-tam*(i),tam);
			}
			if( (data[i+45] & p) == p){
			     dibujarTileColor(BLANCO,(pX + 175)+tam*j,pY-tam*(i),tam);
			}
			p = p/2;
		}	
	}
  	
}
static void gameTest(void){
     if(start==0){
	     int* P[9][5] = {{1,1,1,1,1},
		     {1,0,0,0,1},		
		     {1,0,0,0,1},
		     {1,0,0,0,1},
		     {1,1,1,1,1},
  	             {1,0,0,0,0},
		     {1,0,0,0,0},
                     {1,0,0,0,0},
	             {1,0,0,0,0} };
	     int* A[9][5] = {{1,1,1,1,1},
		     {1,0,0,0,1},		
		     {1,0,0,0,1},
		     {1,0,0,0,1},
		     {1,1,1,1,1},
  	             {1,0,0,0,1},
		     {1,0,0,0,1},
                     {1,0,0,0,1},
	             {1,0,0,0,1} };
             int* R[9][5] = {{1,1,1,1,1},
		     {1,0,0,0,1},		
		     {1,0,0,0,1},
		     {1,0,0,0,1},
		     {1,1,1,1,1},
  	             {1,1,0,0,0},
		     {1,0,1,0,0},
                     {1,0,0,1,0},
	             {1,0,0,0,1} };
             int* E[9][5] = {{1,1,1,1,1},
		     {1,0,0,0,0},		
		     {1,0,0,0,0},
		     {1,0,0,0,0},
		     {1,1,1,1,1},
  	             {1,0,0,0,0},
		     {1,0,0,0,0},
                     {1,0,0,0,0},
	             {1,1,1,1,1} };
             int* S[9][5] = {{1,1,1,1,1},
		     {1,0,0,0,0},		
		     {1,0,0,0,0},
		     {1,0,0,0,0},
		     {1,1,1,1,1},
  	             {0,0,0,0,1},
		     {0,0,0,0,1},
                     {0,0,0,0,1},
	             {1,1,1,1,1} };
             int* T[9][5]={{1,1,1,1,1},
		     {0,0,1,0,0},		
		     {0,0,1,0,0},
		     {0,0,1,0,0},
		     {0,0,1,0,0},
  	             {0,0,1,0,0},
		     {0,0,1,0,0},
                     {0,0,1,0,0},
	             {0,0,1,0,0} };
             int* B[9][5]={{1,1,1,1,0},
		     {1,0,0,0,1},		
		     {1,0,0,0,1},
		     {1,0,0,1,0},
		     {1,1,1,0,0},
  	             {1,0,0,1,0},
		     {1,0,0,0,1},
                     {1,0,0,0,1},
	             {1,1,1,1,0} };
             int* U[9][5]={{1,0,0,0,1},
		     {1,0,0,0,1},		
		     {1,0,0,0,1},
		     {1,0,0,0,1},
		     {1,0,0,0,1},
  	             {1,0,0,0,1},
		     {1,0,0,0,1},
                     {1,0,0,0,1},
	             {1,1,1,1,1} };
             int* O[9][5]={{1,1,1,1,1},
		     {1,0,0,0,1},		
		     {1,0,0,0,1},
		     {1,0,0,0,1},
		     {1,0,0,0,1},
  	             {1,0,0,0,1},
		     {1,0,0,0,1},
                     {1,0,0,0,1},
	             {1,1,1,1,1} };
             int* N[9][5]={{1,0,0,0,1},
		     {1,1,0,0,1},		
		     {1,1,0,0,1},
		     {1,0,1,0,1},
		     {1,0,1,0,1},
  	             {1,0,0,1,1},
		     {1,0,0,1,1},
                     {1,0,0,1,1},
	             {1,0,0,0,1} };

		sdInit();
		lcd_init();
		colorFondo(NEGRO);
		ponerTitulo();
		int pX = 20;
		int pY = 70;
		int tam = 2;
		for (int i=0;i<9;i++){
			for(int j = 0;j<5;j++){
				if( P[i][j] == 1 ){
					dibujarTileColor(BLANCO,pX+tam*j,pY-tam*i,tam);
				}
				if( R[i][j] == 1 ){
					dibujarTileColor(BLANCO,(pX + 18)+tam*j,pY-tam*i,tam);
					dibujarTileColor(BLANCO,(pX + 154)+tam*j,pY-tam*i,tam);
			}
			if( E[i][j] == 1 ){
				dibujarTileColor(BLANCO,(pX + 36)+tam*j,pY-tam*i,tam);
			}
			if( S[i][j] == 1 ){
				dibujarTileColor(BLANCO,(pX + 54)+tam*j,pY-tam*i,tam);
				dibujarTileColor(BLANCO,(pX + 72)+tam*j,pY-tam*i,tam);
				dibujarTileColor(BLANCO,(pX + 100)+tam*j,pY-tam*i,tam);
			}
			if( T[i][j] == 1 ){
				dibujarTileColor( BLANCO,(pX + 118)+tam*j,pY-tam*i,tam);
				dibujarTileColor(BLANCO,(pX + 172)+tam*j,pY-tam*i,tam);
				dibujarTileColor(BLANCO,(pX + 82)+tam*j,(pY-26)-tam*i,tam);			
				dibujarTileColor(BLANCO,(pX + 98)+tam*j,(pY-26)-tam*i,tam);			
			}
			if( A[i][j] == 1 ){
				dibujarTileColor(BLANCO,(pX + 136)+tam*j,pY-tam*i,tam);
			}
			if( B[i][j] == 1 ){
				dibujarTileColor(BLANCO,(pX + 48)+tam*j,(pY-26)-tam*i,tam);
			}
			if( U[i][j] == 1 ){
				dibujarTileColor(BLANCO,(pX + 66)+tam*j,(pY-26)-tam*i,tam);
			}
			if(O[i][j] == 1 ){
				dibujarTileColor(BLANCO,(pX + 114)+tam*j,(pY-26)-tam*i,tam);
			}
			if(N[i][j] == 1 ){
				dibujarTileColor(BLANCO,(pX + 130)+tam*j,(pY-26)-tam*i,tam);
			}	
		}
	   }
	}
	buttons_ev_pending_write(0xFF);
	buttons_ev_enable_write(0xFF);
	irq_setmask(irq_getmask() | ( 1<<4));

}
static void over(void){
	colorFondo(NEGRO);
	dibujarImagen(g_over,110-18,88+12,36,24);
}
static void verificarCorazones(void){
	if(vidas == 2){
			dibujarCorazon(5,165,1);
			dibujarCorazon(5,150,1);
        }
	if(vidas == 1){
			dibujarCorazon(5,165,1);
        }
	if(vidas == 0){
		gameOver = 1;
		over(); 
        }
}
static void console_service(void)
{
	char *str;
	char *token;

	str = readstr();
	if(str == NULL) return;
	token = get_token(&str);
	if(strcmp(token, "help") == 0)
		help();
	else if(strcmp(token, "reboot") == 0)
		reboot();
	else if(strcmp(token, "sdtest") == 0){
		spiSDInit();
		sdInit();
		//escribirNave1();
		//printf("AAA");
		//leerBloque();
		//escribirBloque( 0x00,0x00000000);		
		//leerBloque (0x00000000);
	}
	else if(strcmp(token, "game") == 0){
		gameTest();
	}
	prompt();
}


int main(void)
{
	irq_setmask(0);
	irq_setie(1); //habilita las interrupciones
	uart_init();
	puts("\nTEST PROYECTO FINAL  "__DATE__" "__TIME__"\n");
	while(gameOver==0) {
		//printf("%i \n",buttons_in_read());
		//console_service();
		if(start == 0){
			vidas = 3;
			gameTest();
			start++;
		}else if (start == 1 && juegoIniciado >0 ){
			dibujarTileColor(NEGRO,75,posNaveE,66);
			dibujarNave2(75,posNaveE,1);
			posNaveE = posNaveE - 3;
			posNave1 = getPosNave1();
			if(disparo == 1){
				dibujarTileColor(NEGRO,disparoX,posDisparo,8);
				if(posDisparo > 176){
					disparo = 0;
					posDisparo = 45;
				}else{
					posDisparo = posDisparo + 3;
					dibujarTileColor(ROJO,disparoX,posDisparo,8);
				}
			}
			if(posNaveE <= 35 && (  posNave1 >= 75 && posNave1 <= 66+75  ) ){
				vidas --;
				disparo = 0;
				posDisparo = 45;
				colorFondo(NEGRO);
				if(vidas > 0){		
					dibujarNave2(75,168,1);
					dibujarNave1(88,35,2);
				}
				posNaveE = 168;
				posNave1 = 88;
			}
			if(posNaveE < 0){
				posNaveE = 168;
			}	
			if (( posDisparo <= posNaveE && posDisparo >= posNaveE-27) && ( disparoX >= 75 && disparoX <= 66 + 75) ){
				borrarImagen(75,posNaveE+5,66,30);	
				dibujarImagen(exp,97,posNaveE-13,31,29);
				busy_wait(1);		
				gameOver = 1;	
			}
			verificarCorazones();
			busy_wait(1);		
		}

	}
	return 0;
}

